<!DOCTYPE html>
<html lang="en">
    <script type=text/javascript
          src="http://ajax.googleapis.com/ajax/libs/jquery/1.8.2/jquery.min.js"></script>
        <script type=text/javascript>
          var $SCRIPT_ROOT = {{ request.script_root|tojson|safe }};
        </script>   
 
 
<head>
</head>
<body onload="init()">
    <canvas style="height: 200px; width: 200px; border: 2px solid black;" id="can"></canvas>
    <a href="#" class="button" id="btn-download" download="../Desktop/my-file-name.png">Download</a>
    <button onclick="get_pixel_data()">to blob</button>
    <canvas style="height: 200px; width: 200px; border: 2px solid black;" id="can2"></canvas>
    <form action = "{{ url_for('model_predict') }}" enctype="multipart/form-data" method = "POST">
        <input type="hidden" name="pixels" id="pixel_data" value='' />
        <input type="submit" />
    </form>
    
        
</body>
<script type=text/javascript>
        var canvas = document.getElementById("can");
        var ctx = can.getContext("2d");
        var height = canvas.height; 
	var width = canvas.width;
    var x1 = null;
    var x2 = null;
    var y1 = null;
    var y2 = null;
    function init() {    
        var img = new Image();
        img.src = '{{ file }}';
        ctx.drawImage(img, 0, 0, width, height);
        document.getElementById('pixel_data').value = canvas.toDataURL("img/png");
    };


var mouse = {x: 0, y: 0};
    

canvas.addEventListener('mousemove', function(e) {
  mouse.x = e.pageX + (3*canvas.offsetLeft);
  mouse.y = e.pageY - (2*canvas.offsetTop);
  console.log(canvas.offsetLeft);
}, false);

ctx.lineWidth = 3;
ctx.lineJoin = 'round';
ctx.lineCap = 'round';
ctx.strokeStyle = 'rgb(255, 0, 0)';
var origin_x = 0;
var origin_y = 0;
 
canvas.addEventListener('mousedown', function(e) {
    ctx.beginPath();
    origin_x = mouse.x;
    origin_y = mouse.y;
    console.log(origin_x);
    ctx.moveTo(mouse.x, mouse.y);
    canvas.addEventListener('mousemove', onPaint, false);
}, false);
 
canvas.addEventListener('mouseup', function() {
    canvas.removeEventListener('mousemove', onPaint, false);
    ctx.beginPath();
    ctx.moveTo(mouse.x,mouse.y);
    ctx.lineTo(origin_x,origin_y);
    ctx.stroke();
    document.getElementById('pixel_data').value = canvas.toDataURL("img/png");
}, false);
 
var onPaint = function() {
    ctx.lineTo(mouse.x, mouse.y);
    ctx.stroke();
};



function get_pixel_data() {
    x1 = crop()[0];
    x2 = crop()[2];
    y1 =  crop()[1];
    y2 = crop()[3];
    //(document.getElementById("can2").getContext("2d")).putImageData(pixels,0,0);
    /*var pixels = new Array(y2-y1);
    for(var i=y1; i<y2; i++) {
        pixels[i-y1] = new Array(x2-x1);
        for(var c=x1; c<x2; c++) {
            pixels[i-y1][c-x1] = ctx.getImageData(i,c,i+1,c+1).data;
        }
    }*/
    //console.log(pixels);
    
    
    //(document.getElementById("can2").getContext("2d")).fillRect(x1,y1,x2-x1,y2-y1);
    //document.getElementById('pixel_data').value = ctx.getImageData(x1,y1,x2,y2);
}
function predict() {
    //get_pixel_data();
    //var pixel_data = ctx.getImageData(x1,y1,x2,y2);
    var dataUrl = canvas.toDataUrl();
    document.getElementById('pixel_data').value = dataUrl;
}


function crop() {
    var firstX = 1000;
    var firstY = 1000;
    var lastX = -1;
    var lastY = -1;
	for(var i=0; i<width; i++) {
		for(var c=0; c<height; c++) {
		if((ctx.getImageData(i,c,1,1).data)[0] == 255 && (ctx.getImageData(i,c,1,1).data)[1] == 0 && (ctx.getImageData(i,c,1,1).data)[2] == 0) {
				if(i < firstX) {
					firstX = i;
				} 
				if(i > lastX) {
					lastX = i;
				}
				if(c < firstY) {
					firstY = c;
				} 
				if(c > lastY) {
					lastY = c;
				}
			}
		}		
	}
    return [firstX, firstY, lastX, lastY];
    
}






    
    
</script>